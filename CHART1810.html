<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 Chart - Theo gi·ªù</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #chartContainer {
      width: 100%;
      height: calc(100% - 60px);
      padding: 10px;
      box-sizing: border-box;
    }
    #controlPanel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
    }
    input, button {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    button:hover {
      background: #333;
    }
    #status {
      text-align: center;
      font-size: 14px;
      color: #bbb;
      margin-bottom: 5px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div id="controlPanel">
    <label>T·ª´:</label>
    <input type="time" id="startTime" value="00:00">
    <label>ƒê·∫øn:</label>
    <input type="time" id="endTime" value="23:59">
    <button onclick="filterByTime()">Xem d·ªØ li·ªáu</button>
    <button onclick="reloadData()">üîÑ L√†m m·ªõi</button>
  </div>

  <div id="chartContainer">
    <div id="status">üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <canvas id="espChart"></canvas>
  </div>

  <script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbxhPINgsxcHQn12TCW2h6nbAX4HPPB9wGGCFNXvTs6QcKmfwqekvlZIt13troVh2Qcj/exec";
  let chart, allData = [];

  function createChart(labels, tempData, humData, relayData) {
    const ctx = document.getElementById('espChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'üå°Ô∏è Nhi·ªát ƒë·ªô (¬∞C)',
            data: tempData,
            borderColor: '#ff5252',
            backgroundColor: 'rgba(255,82,82,0.2)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y'
          },
          {
            label: 'üíß ƒê·ªô ·∫©m (%)',
            data: humData,
            borderColor: '#42a5f5',
            backgroundColor: 'rgba(66,165,245,0.2)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y'
          },
          {
            label: '‚ö° Relay',
            data: relayData,
            borderColor: '#00e676',
            borderWidth: 2,
            stepped: true,
            pointRadius: 3,
            fill: false,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom', labels: { color: '#ddd' } }
        },
        scales: {
          x: {
            ticks: {
              color: '#aaa',
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 10,
              callback: (v, i) => {
                const date = new Date(labels[i]);
                return date.toLocaleTimeString("vi-VN", { hour: '2-digit', minute: '2-digit' });
              }
            },
            grid: { color: '#333' }
          },
          y: {
            title: { display: true, text: '¬∞C / %', color: '#ccc' },
            ticks: { color: '#aaa' },
            grid: { color: '#333' }
          },
          y1: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#aaa',
              stepSize: 1,
              callback: v => v === 1 ? 'ON' : 'OFF'
            }
          }
        }
      }
    });
  }

  async function loadDataAndDraw() {
    try {
      document.getElementById("status").innerText = "üîÑ ƒêang t·∫£i d·ªØ li·ªáu...";
      const res = await fetch(apiUrl);
      const data = await res.json();
      allData = data; // l∆∞u t·∫•t c·∫£ ƒë·ªÉ l·ªçc sau
      filterByTime(); // v·∫Ω theo kho·∫£ng gi·ªù m·∫∑c ƒë·ªãnh
      document.getElementById("status").innerText = "‚úÖ D·ªØ li·ªáu c·∫≠p nh·∫≠t: " + new Date().toLocaleTimeString("vi-VN");
    } catch (e) {
      document.getElementById("status").innerText = "‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu!";
      console.error(e);
    }
  }

  function filterByTime() {
    if (!allData.length) return;
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;

    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);

    const startMs = sh * 60 + sm;
    const endMs = eh * 60 + em;

    // l·ªçc theo gi·ªù trong ng√†y (gi·∫£ ƒë·ªãnh d·ªØ li·ªáu h√¥m nay)
    const filtered = allData.filter(r => {
      const t = new Date(r.time);
      const total = t.getHours() * 60 + t.getMinutes();
      return total >= startMs && total <= endMs;
    });

    const latest = filtered.slice(-200); // tr√°nh lag
    const labels = latest.map(r => new Date(r.time));
    const temp = latest.map(r => r.temp);
    const hum = latest.map(r => r.hum);
    const relay = latest.map(r => r.relay);

    createChart(labels, temp, hum, relay);
  }

  function reloadData() {
    loadDataAndDraw();
  }

  // Khi App Inventor g·ª≠i reloadData
  setInterval(() => {
    if (window.AppInventor) {
      const cmd = window.AppInventor.getWebViewString();
      if (cmd === "reloadData") {
        reloadData();
        window.AppInventor.setWebViewString("");
      }
    }
  }, 3000);

  loadDataAndDraw();
  </script>
</body>
</html>
