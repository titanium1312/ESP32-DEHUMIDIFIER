<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 Chart - Theo gi·ªù</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #chartContainer {
      width: 100%;
      height: calc(100% - 60px);
      padding: 10px;
      overflow-x: auto; // m·ªõi 18/10
      //box-sizing: border-box;
    }
    #controlPanel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
    }
    input, button {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    button:hover {
      background: #333;
    }
    #status {
      text-align: center;
      font-size: 14px;
      color: #bbb;
      margin-bottom: 5px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <h2>Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô, ƒë·ªô ·∫©m v√† tr·∫°ng th√°i relay</h2>
  <div id="chartContainer">
    <canvas id="espChart"></canvas>
  <!-- B·ªô l·ªçc th·ªùi gian -->
  <div style="margin-bottom: 10px;">
    <label>T·ª´ ng√†y:</label>
    <input type="date" id="startDate">
    <label>ƒê·∫øn ng√†y:</label>
    <input type="date" id="endDate">
    <label>T·ª´ gi·ªù:</label>
    <input type="time" id="startTime" value="00:00">
    <label>ƒê·∫øn gi·ªù:</label>
    <input type="time" id="endTime" value="23:59">
    <button onclick="applyFilter()">L·ªçc d·ªØ li·ªáu</button>
    <button onclick="resetFilter()">Hi·ªÉn th·ªã t·∫•t c·∫£</button>
  </div>

  <script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbxhPINgsxcHQn12TCW2h6nbAX4HPPB9wGGCFNXvTs6QcKmfwqekvlZIt13troVh2Qcj/exec";
  let chart;
  let allData = []; // L∆∞u to√†n b·ªô d·ªØ li·ªáu g·ªëc

  function createChart(labels, tempData, humData, relayData) {
    const ctx = document.getElementById('espChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: tempData, borderColor: 'red', fill: false, yAxisID: 'y' },
          { label: 'ƒê·ªô ·∫©m (%)', data: humData, borderColor: 'blue', fill: false, yAxisID: 'y' },
          { label: 'Relay', data: relayData, borderColor: 'green', stepped: true, fill: false, yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: { title: { display: true, text: 'D·ªØ li·ªáu t·ª´ ESP32' } },
        scales: {
          x: { ticks: { maxRotation: 90, minRotation: 45 } },
          y: { type: 'linear', display: true, position: 'left' },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              stepSize: 1,
              callback: v => v === 1 ? 'ON' : 'OFF'
            }
          }
        }
      }
    });
  }

  function loadDataAndDraw() {
    fetch(apiUrl)
      .then(r => r.json())
      .then(data => {
        allData = data; // l∆∞u b·∫£n g·ªëc
        updateChart(data);
      })
      .catch(err => console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err));
  }

  function updateChart(data) {
    const labels = data.map(row => new Date(row.time).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" }));
    const tempData = data.map(row => row.temp);
    const humData = data.map(row => row.hum);
    const relayData = data.map(row => row.relay);

    if (!chart) createChart(labels, tempData, humData, relayData);
    else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = tempData;
      chart.data.datasets[1].data = humData;
      chart.data.datasets[2].data = relayData;
      chart.update();
    }
  }

  // üîç L·ªçc theo ng√†y + gi·ªù
  function applyFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!startDate || !endDate) {
      alert("Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
      return;
    }

    const start = new Date(`${startDate}T${startTime}`);
    const end = new Date(`${endDate}T${endTime}`);

    const filtered = allData.filter(row => {
      const t = new Date(row.time);
      return t >= start && t <= end;
    });

    updateChart(filtered);
  }

  // üîÅ Hi·ªÉn th·ªã l·∫°i to√†n b·ªô
  function resetFilter() {
    updateChart(allData);
  }

  // üîÑ Cho App Inventor g·ªçi
  function reloadData() {
    console.log("Reload d·ªØ li·ªáu t·ª´ App Inventor...");
    loadDataAndDraw();
  }

  loadDataAndDraw();

  // Theo d√µi WebViewString
  setInterval(() => {
    if (window.AppInventor) {
      const cmd = window.AppInventor.getWebViewString();
      if (cmd === "reloadData") {
        reloadData();
        window.AppInventor.setWebViewString("");
      }
    }
  }, 1000);
  </script>
</body>
</html>


