<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Biá»ƒu Ä‘á»“ ESP32</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>Biá»ƒu Ä‘á»“ nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m vÃ  tráº¡ng thÃ¡i relay</h2>
  <canvas id="espChart"></canvas>
  <script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbxhPINgsxcHQn12TCW2h6nbAX4HPPB9wGGCFNXvTs6QcKmfwqekvlZIt13troVh2Qcj/exec";
  let chart; // Biáº¿n lÆ°u biá»ƒu Ä‘á»“ toÃ n cá»¥c

  // ðŸŸ¢ HÃ m táº¡o biá»ƒu Ä‘á»“ láº§n Ä‘áº§u
  function createChart(labels, tempData, humData, relayData) {
    const ctx = document.getElementById('espChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Nhiá»‡t Ä‘á»™ (Â°C)', data: tempData, borderColor: 'red', fill: false, yAxisID: 'y' },
          { label: 'Äá»™ áº©m (%)', data: humData, borderColor: 'blue', fill: false, yAxisID: 'y' },
          { label: 'Relay', data: relayData, borderColor: 'green', stepped: true, fill: false, yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: { title: { display: true, text: 'Dá»¯ liá»‡u tá»« ESP32' } },
        scales: {
          x: { ticks: { maxRotation: 90, minRotation: 45 } },
          y: { type: 'linear', display: true, position: 'left' },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              stepSize: 1,
              callback: function(value) {
                return value === 1 ? 'ON' : 'OFF';
              }
            }
          }
        }
      }
    });
  }

  // ðŸŸ¢ HÃ m táº£i vÃ  cáº­p nháº­t dá»¯ liá»‡u
  function loadDataAndDraw() {
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        const labels = data.map(row => new Date(row.time).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" }));
        const tempData = data.map(row => row.temp);
        const humData = data.map(row => row.hum);
        const relayData = data.map(row => row.relay);

        if (!chart) {
          createChart(labels, tempData, humData, relayData);
        } else {
          chart.data.labels = labels;
          chart.data.datasets[0].data = tempData;
          chart.data.datasets[1].data = humData;
          chart.data.datasets[2].data = relayData;
          chart.update();
        }
      })
      .catch(err => console.error("Lá»—i táº£i dá»¯ liá»‡u:", err));
  }

  // ðŸŸ¢ HÃ m reloadData Ä‘Æ°á»£c App Inventor gá»i giÃ¡n tiáº¿p
  function reloadData() {
    console.log("Reload dá»¯ liá»‡u tá»« App Inventor...");
    loadDataAndDraw();
  }

  // âš¡ Gá»i láº§n Ä‘áº§u Ä‘á»ƒ hiá»ƒn thá»‹ biá»ƒu Ä‘á»“
  loadDataAndDraw();

  // ðŸŸ¢ Theo dÃµi WebViewString Ä‘á»ƒ nháº­n lá»‡nh "reloadData"
  setInterval(() => {
    if (window.AppInventor) {
      const cmd = window.AppInventor.getWebViewString();
      if (cmd === "reloadData") {
        reloadData();
        window.AppInventor.setWebViewString(""); // XÃ³a sau khi xá»­ lÃ½
      }
    }
  }, 1000);
  </script>
</body>
</html>

