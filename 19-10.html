<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Chart - Theo gi·ªù</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #chartContainer {
      width: 100%;
      height: calc(100% - 60px);
      padding: 10px;
      box-sizing: border-box;
    }
    #chartWrapper {
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: hidden;
    }
    #espChart {
      min-width: 1500px; /* üëà ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông ƒë·ªÉ cu·ªôn ngang */
      height: 100%;
    }
    #controlPanel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
      flex-wrap: wrap;
    }
    input, button {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    button:hover {
      background: #333;
    }
    h2 {
      text-align: center;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô, ƒë·ªô ·∫©m v√† tr·∫°ng th√°i relay</h2>

  <div id="chartContainer">
    <div id="chartWrapper">
      <canvas id="espChart"></canvas>
    </div>
  </div>

  <div id="controlPanel">
    <label>T·ª´ ng√†y:</label>
    <input type="date" id="startDate">
    <label>ƒê·∫øn ng√†y:</label>
    <input type="date" id="endDate">
    <label>T·ª´ gi·ªù:</label>
    <input type="time" id="startTime" value="00:00">
    <label>ƒê·∫øn gi·ªù:</label>
    <input type="time" id="endTime" value="23:59">
    <button onclick="applyFilter()">L·ªçc d·ªØ li·ªáu</button>
    <button onclick="resetFilter()">Hi·ªÉn th·ªã t·∫•t c·∫£</button>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbxhPINgsxcHQn12TCW2h6nbAX4HPPB9wGGCFNXvTs6QcKmfwqekvlZIt13troVh2Qcj/exec";
    let chart;
    let allData = [];

    function createChart(labels, tempData, humData, relayData) {
      const ctx = document.getElementById('espChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: tempData, borderColor: 'red', fill: false, yAxisID: 'y' },
            { label: 'ƒê·ªô ·∫©m (%)', data: humData, borderColor: 'blue', fill: false, yAxisID: 'y' },
            { label: 'Relay', data: relayData, borderColor: 'green', stepped: true, fill: false, yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          plugins: { title: { display: true, text: 'D·ªØ li·ªáu t·ª´ ESP32' } },
          scales: {
            x: {
              ticks: { maxRotation: 90, minRotation: 45 },
              title: { display: true, text: 'Th·ªùi gian' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Nhi·ªát ƒë·ªô / ƒê·ªô ·∫©m' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: {
                stepSize: 1,
                callback: v => v === 1 ? 'ON' : 'OFF'
              },
              title: { display: true, text: 'Relay' }
            }
          }
        }
      });
    }

    function updateChart(data) {
      if (!Array.isArray(data) || data.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.");
        return;
      }

      const labels = data.map(row => new Date(row.time).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" }));
      const tempData = data.map(row => row.temp);
      const humData = data.map(row => row.hum);
      const relayData = data.map(row => {
        if (row.relay === "ON") return 1;
        if (row.relay === "OFF") return 0;
        return row.relay;
      });

      if (!chart) createChart(labels, tempData, humData, relayData);
      else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = tempData;
        chart.data.datasets[1].data = humData;
        chart.data.datasets[2].data = relayData;
        chart.update();
      }
    }

    function loadDataAndDraw() {
      fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
          if (!Array.isArray(data)) {
            console.error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá:", data);
            return;
          }
          allData = data;
          updateChart(data);
        })
        .catch(err => {
          console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err);
          alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß.");
        });
    }

    function applyFilter() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startDate || !endDate) {
        alert("Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
        return;
      }

      const start = new Date(`${startDate}T${startTime}`);
      const end = new Date(`${endDate}T${endTime}`);

      const filtered = allData.filter(row => {
        const t = new Date(row.time);
        return t >= start && t <= end;
      });

      if (filtered.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.");
        return;
      }

      updateChart(filtered);
    }

    function resetFilter() {
      updateChart(allData);
    }

    function reloadData() {
      console.log("Reload d·ªØ li·ªáu t·ª´ App Inventor...");
      loadDataAndDraw();
    }

    loadDataAndDraw();

    setInterval(() => {
      if (window.AppInventor) {
        const cmd = window.AppInventor.getWebViewString();
        if (cmd === "reloadData") {
          reloadData();
          window.AppInventor.setWebViewString("");
        }
      }
    }, 1000);
  </script>
</body>
</html>
